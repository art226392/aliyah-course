<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Aliyah Course - Assessment 1</title>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <!-- Unified Stylesheet -->
    <link rel="stylesheet" href="style.css" />
    <style>
      /* Fireworks Canvas Styling */
      #fireworks-canvas {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 999;
      }

      /* Success Animation for Next Button */
      @keyframes pulseGlow {
        0% {
          box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7);
        }
        70% {
          box-shadow: 0 0 0 10px rgba(40, 167, 69, 0);
        }
        100% {
          box-shadow: 0 0 0 0 rgba(40, 167, 69, 0);
        }
      }

      #next-lecture-btn.celebrate {
        animation: pulseGlow 2s infinite;
      }

      /* Confetti Text Animation */
      @keyframes celebrate {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.05);
        }
      }

      .grade-pass.celebrating {
        animation: celebrate 0.5s ease-in-out;
      }
    </style>
  </head>
  <body>
    <canvas id="fireworks-canvas"></canvas>
    <div class="container">
      <header class="quiz-header">
        <h1>Assessment 1</h1>
        <div class="progress-bar-container">
          <div class="progress-bar" id="progress-bar"></div>
        </div>
        <div class="stats-container">
          <div id="question-counter">Answered: 0 / 15</div>
          <div id="timer">Time Left: 08:00</div>
        </div>
      </header>

      <form id="quiz-form">
        <div id="questions-wrapper">
          <!-- Questions will be dynamically inserted here by JavaScript -->
        </div>
        <button type="submit" id="submit-btn" disabled>
          Submit Assessment
        </button>
      </form>
    </div>

    <!-- Results Modal -->
    <div id="results-modal" class="modal-overlay">
      <div class="modal-content">
        <h2>Assessment Complete</h2>
        <div id="score-percentage">0%</div>
        <div id="grade-level"></div>
        <p id="feedback-text"></p>
        <div id="answer-review"></div>
        <div class="modal-buttons">
          <a href="index.html" class="nav-btn secondary">Return to Lecture</a>
          <button id="retry-btn" class="nav-btn secondary">Retry Quiz</button>
          <!-- This button is hidden by default and shown on pass -->
          <a href="#" id="next-lecture-btn" class="nav-btn">Next Lecture →</a>
        </div>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        // --- QUIZ DATA - STRICTLY FROM LECTURE 1 ONLY ---
        const quizQuestions = [
          {
            question:
              "According to the introduction, what spans centuries, continents, and countless individual lives?",
            options: [
              "The history of Jerusalem",
              "The return of the Jewish people to their ancestral homeland",
              "The development of Hebrew language",
              "The building of synagogues worldwide",
            ],
            answer: 1,
          },
          {
            question: "What does the text state is at the heart of this story?",
            options: [
              "The Mosaic Law",
              "The Temple Mount",
              "The Abrahamic Covenant",
              "The State of Israel's founding",
            ],
            answer: 2,
          },
          {
            question:
              "According to the text, what kind of possession did God promise the land of Israel would be?",
            options: ["Temporary", "Conditional", "Everlasting", "Shared"],
            answer: 2,
          },
          {
            question:
              "The text states that the covenant is NOT conditional on what?",
            options: [
              "The faithfulness or worthiness of the Jewish people",
              "International recognition",
              "Political stability",
              "Economic prosperity",
            ],
            answer: 0,
          },
          {
            question:
              "What does the text say happens even when God's people falter or stray?",
            options: [
              "The covenant is cancelled",
              "God finds a new people",
              "God keeps His promises",
              "The land is given to others",
            ],
            answer: 2,
          },
          {
            question:
              "According to the introduction, the return of the Jewish people is described as what kind of demonstration?",
            options: [
              "A political demonstration",
              "A demonstration of God's faithfulness and His sovereign plan",
              "A military demonstration",
              "An economic demonstration",
            ],
            answer: 1,
          },
          {
            question:
              "Which book and chapter does the text reference when discussing Israel's restoration being linked to the blessing of nations?",
            options: ["Genesis 12", "Isaiah 40", "Romans 11", "Revelation 21"],
            answer: 2,
          },
          {
            question:
              "What phrase does Paul use to describe what it will be like for the world when Jewish people return to God?",
            options: [
              "A new covenant",
              "Life from the dead",
              "The end of days",
              "Peace on earth",
            ],
            answer: 1,
          },
          {
            question:
              "The dissertation will trace the theme of ingathering throughout which parts of the Bible?",
            options: [
              "Only the Old Testament",
              "Only the New Testament",
              "The Old and New Testaments",
              "The Prophetic books only",
            ],
            answer: 2,
          },
          {
            question:
              "When did the early pioneers mentioned in the text settle the land?",
            options: [
              "Early 19th century",
              "Late 19th century",
              "Early 20th century",
              "Mid-20th century",
            ],
            answer: 1,
          },
          {
            question:
              "From where does the text say waves of immigrants have come in recent decades?",
            options: [
              "Only from Europe",
              "Only from Russia",
              "The four corners of the earth",
              "Neighboring countries only",
            ],
            answer: 2,
          },
          {
            question:
              "What does the dissertation aim to demonstrate about Aliyah's place in God's plan?",
            options: [
              "It is a peripheral issue",
              "It is a modern political movement",
              "It is central and pivotal to God's redemptive plan",
              "It is symbolic only",
            ],
            answer: 2,
          },
          {
            question:
              "According to the text, what are the Jewish people setting the stage for as they return?",
            options: [
              "World peace negotiations",
              "The climactic events of the last days and the coming of the Messiah",
              "A new world order",
              "The rebuilding of the Temple only",
            ],
            answer: 1,
          },
          {
            question:
              "What does the text say will be established when the Messiah comes?",
            options: [
              "A new covenant only",
              "Peace in the Middle East",
              "His kingdom on earth",
              "The third temple",
            ],
            answer: 2,
          },
          {
            question: "Who is credited as the author of this course?",
            options: [
              "Dr. Abraham Cohen",
              "Arthur Howard Flower Th.D.",
              "Professor David Stone",
              "Rabbi Samuel Green",
            ],
            answer: 1,
          },
        ];

        // --- DOM ELEMENTS ---
        const questionsWrapper = document.getElementById("questions-wrapper");
        const quizForm = document.getElementById("quiz-form");
        const submitBtn = document.getElementById("submit-btn");
        const progressBar = document.getElementById("progress-bar");
        const questionCounter = document.getElementById("question-counter");
        const timerEl = document.getElementById("timer");
        const resultsModal = document.getElementById("results-modal");
        const scorePercentageEl = document.getElementById("score-percentage");
        const gradeLevelEl = document.getElementById("grade-level");
        const feedbackTextEl = document.getElementById("feedback-text");
        const retryBtn = document.getElementById("retry-btn");
        const answerReviewEl = document.getElementById("answer-review");
        const nextLectureBtn = document.getElementById("next-lecture-btn");

        // --- STATE VARIABLES ---
        let userAnswers = new Array(quizQuestions.length).fill(null);
        let timerInterval;
        let timeLeft = 600; // 12 minutes in seconds
        let quizInProgress = true;

        // --- FIREWORKS ANIMATION ---
        class Fireworks {
          constructor() {
            this.canvas = document.getElementById("fireworks-canvas");
            this.ctx = this.canvas.getContext("2d");
            this.particles = [];
            this.rockets = [];
            this.resize();
            window.addEventListener("resize", () => this.resize());
          }

          resize() {
            this.canvas.width = window.innerWidth;
            this.canvas.height = window.innerHeight;
          }

          createRocket() {
            const rocket = {
              x: Math.random() * this.canvas.width,
              y: this.canvas.height,
              vx: (Math.random() - 0.5) * 2,
              vy: -Math.random() * 3 - 12,
              trail: [],
            };
            this.rockets.push(rocket);
          }

          explode(x, y) {
            const colors = [
              "#FFD700",
              "#FF69B4",
              "#00CED1",
              "#FF6347",
              "#9370DB",
              "#32CD32",
            ];
            const color = colors[Math.floor(Math.random() * colors.length)];
            const particleCount = 30 + Math.floor(Math.random() * 20);

            for (let i = 0; i < particleCount; i++) {
              const angle = (Math.PI * 2 * i) / particleCount;
              const velocity = 2 + Math.random() * 3;
              this.particles.push({
                x: x,
                y: y,
                vx: Math.cos(angle) * velocity,
                vy: Math.sin(angle) * velocity,
                color: color,
                life: 1,
                decay: 0.015 + Math.random() * 0.01,
              });
            }
          }

          update() {
            // Update rockets
            for (let i = this.rockets.length - 1; i >= 0; i--) {
              const rocket = this.rockets[i];
              rocket.vy += 0.15; // gravity
              rocket.x += rocket.vx;
              rocket.y += rocket.vy;

              rocket.trail.push({ x: rocket.x, y: rocket.y });
              if (rocket.trail.length > 10) rocket.trail.shift();

              if (rocket.vy >= 0) {
                this.explode(rocket.x, rocket.y);
                this.rockets.splice(i, 1);
              }
            }

            // Update particles
            for (let i = this.particles.length - 1; i >= 0; i--) {
              const p = this.particles[i];
              p.x += p.vx;
              p.y += p.vy;
              p.vy += 0.05; // gravity
              p.vx *= 0.99; // air resistance
              p.life -= p.decay;

              if (p.life <= 0) {
                this.particles.splice(i, 1);
              }
            }
          }

          draw() {
            this.ctx.fillStyle = "rgba(0, 0, 0, 0.1)";
            this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);

            // Draw rockets
            this.rockets.forEach((rocket) => {
              this.ctx.beginPath();
              this.ctx.strokeStyle = "rgba(255, 255, 255, 0.8)";
              this.ctx.lineWidth = 2;
              if (rocket.trail.length > 1) {
                this.ctx.moveTo(rocket.trail[0].x, rocket.trail[0].y);
                for (let i = 1; i < rocket.trail.length; i++) {
                  this.ctx.lineTo(rocket.trail[i].x, rocket.trail[i].y);
                }
              }
              this.ctx.stroke();
            });

            // Draw particles
            this.particles.forEach((p) => {
              this.ctx.globalAlpha = p.life;
              this.ctx.fillStyle = p.color;
              this.ctx.beginPath();
              this.ctx.arc(p.x, p.y, 2 + p.life * 2, 0, Math.PI * 2);
              this.ctx.fill();
            });
            this.ctx.globalAlpha = 1;
          }

          start() {
            this.animationId = null;
            const animate = () => {
              this.update();
              this.draw();
              this.animationId = requestAnimationFrame(animate);
            };
            animate();

            // Launch rockets periodically
            this.rocketInterval = setInterval(() => {
              this.createRocket();
            }, 400);

            // Stop after 5 seconds
            setTimeout(() => {
              this.stop();
            }, 5000);
          }

          stop() {
            if (this.rocketInterval) {
              clearInterval(this.rocketInterval);
              this.rocketInterval = null;
            }

            // Let existing particles finish
            const cleanup = () => {
              if (this.particles.length > 0 || this.rockets.length > 0) {
                this.update();
                this.draw();
                requestAnimationFrame(cleanup);
              } else {
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                if (this.animationId) {
                  cancelAnimationFrame(this.animationId);
                }
              }
            };
            cleanup();
          }
        }

        // --- FUNCTIONS ---

        /**
         * Renders the questions and options to the DOM.
         */
        function renderQuestions() {
          let questionsHTML = "";
          quizQuestions.forEach((q, index) => {
            questionsHTML += `
              <div class="question-block">
                <h2>${index + 1}. ${q.question}</h2>
                <ul class="options-list" data-question-index="${index}">
                  ${q.options
                    .map((opt, i) => `<li data-option-index="${i}">${opt}</li>`)
                    .join("")}
                </ul>
              </div>`;
          });
          questionsWrapper.innerHTML = questionsHTML;
        }

        /**
         * Handles the user selecting an answer.
         * @param {Event} e The click event.
         */
        function handleOptionSelect(e) {
          if (!quizInProgress || !e.target.matches("li")) return;

          const questionIndex = e.target.parentElement.dataset.questionIndex;
          const optionIndex = e.target.dataset.optionIndex;

          userAnswers[questionIndex] = parseInt(optionIndex);

          // Update visual selection
          const options = e.target.parentElement.querySelectorAll("li");
          options.forEach((opt) => opt.classList.remove("selected"));
          e.target.classList.add("selected");

          updateProgress();
        }

        /**
         * Updates the progress bar and question counter.
         */
        function updateProgress() {
          const answeredCount = userAnswers.filter((a) => a !== null).length;
          const progress = (answeredCount / quizQuestions.length) * 100;
          progressBar.style.width = `${progress}%`;
          questionCounter.textContent = `Answered: ${answeredCount} / ${quizQuestions.length}`;
          submitBtn.disabled = answeredCount !== quizQuestions.length;
        }

        /**
         * Starts the 8-minute countdown timer.
         */
        function startTimer() {
          timerInterval = setInterval(() => {
            timeLeft--;
            const mins = Math.floor(timeLeft / 60)
              .toString()
              .padStart(2, "0");
            const secs = (timeLeft % 60).toString().padStart(2, "0");
            timerEl.textContent = `Time Left: ${mins}:${secs}`;

            if (timeLeft <= 0) {
              timerEl.textContent = "Time's Up!";
              showResults(); // Auto-submit when time runs out
            }
          }, 1000);
        }

        /**
         * Calculates score, displays results, and enforces pass/fail logic.
         */
        function showResults() {
          if (!quizInProgress) return; // Prevent multiple submissions
          quizInProgress = false;
          clearInterval(timerInterval);

          let score = 0;
          userAnswers.forEach((answer, index) => {
            if (answer === quizQuestions[index].answer) {
              score++;
            }
          });

          const percentage = Math.round((score / quizQuestions.length) * 100);
          scorePercentageEl.textContent = `${percentage}%`;

          // NEW: Enforce 80% pass condition with celebration
          if (percentage >= 80) {
            gradeLevelEl.textContent = "PASS";
            gradeLevelEl.className = "grade-pass celebrating";
            feedbackTextEl.textContent =
              "Excellent! You have a strong understanding of the material. You may proceed to the next lecture.";
            nextLectureBtn.style.display = "inline-block"; // Show button
            nextLectureBtn.href = "lecture2.html"; // Set link
            nextLectureBtn.classList.add("celebrate");

            // Start fireworks animation
            setTimeout(() => {
              const fireworks = new Fireworks();
              fireworks.start();
            }, 500);
          } else {
            gradeLevelEl.textContent = "FAIL";
            gradeLevelEl.className = "grade-fail";
            feedbackTextEl.textContent = `You scored ${percentage}%. A score of 80% is required to pass. Please review the material and try again.`;
            nextLectureBtn.style.display = "none"; // Hide button
          }

          renderAnswerReview();
          resultsModal.style.display = "flex";
        }

        /**
         * Generates the HTML for the answer review section in the modal.
         */
        function renderAnswerReview() {
          let reviewHTML = "";
          quizQuestions.forEach((q, index) => {
            const userAnswerIndex = userAnswers[index];
            const correctAnswerIndex = q.answer;
            const isCorrect = userAnswerIndex === correctAnswerIndex;
            const userAnswerText =
              userAnswerIndex !== null
                ? q.options[userAnswerIndex]
                : "No answer";

            reviewHTML += `
              <div class="review-item ${isCorrect ? "correct" : "incorrect"}">
                <p class="review-question">${index + 1}. ${q.question}</p>
                <p>Your answer: 
                  <span class="${
                    isCorrect ? "correct-answer" : "incorrect-answer"
                  }">${isCorrect ? "✓" : "✗"} ${userAnswerText}</span>
                </p>
                ${
                  !isCorrect
                    ? `<p>Correct answer: <span class="correct-answer">${q.options[correctAnswerIndex]}</span></p>`
                    : ""
                }
              </div>`;
          });
          answerReviewEl.innerHTML = reviewHTML;
        }

        // --- EVENT LISTENERS ---
        questionsWrapper.addEventListener("click", handleOptionSelect);
        quizForm.addEventListener("submit", (e) => {
          e.preventDefault();
          showResults();
        });
        retryBtn.addEventListener("click", () => {
          window.location.reload();
        });

        // --- INITIALIZATION ---
        renderQuestions();
        startTimer();
      });
    </script>
    <script src="./progress.js" defer></script>
  </body>
</html>
